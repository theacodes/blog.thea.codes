<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="author" content="Thea Flowers">
  <link rel="shortcut icon" href="https://blog.thea.codes/favicon.ico">

  <title>The most thoroughly commented linker script (probably) - Stargirl (Thea) Flowers</title>

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" href="https://blog.thea.codes/feed.xml" />

  <!-- Bootstrap core CSS -->
  <link href="/static/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="/static/style.css" rel="stylesheet">

  <!-- Syntax highlighting css -->
  <link href="/static/pygments.css" rel="stylesheet">

  
<meta property="og:title" content="The most thoroughly commented linker script (probably) - Thea Flowers">
<meta property="twitter:title" content="The most thoroughly commented linker script (probably) - Thea Flowers">


<meta property="og:description" content="A deep look into the black magic that is linker scripts.">
<meta property="twitter:description" content="A deep look into the black magic that is linker scripts.">






<meta property="og:url" content="https://blog.thea.codes/the-most-thoroughly-commented-linker-script">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@theavalkyrie">

</head>
<body>
  <div class="container">

    
<article>
  <aside class="timestamp">
    <time>Posted by Stargirl Flowers on January 13, 2021</time>
    Â· <a href="/">view all posts</a>
  </aside>
  <h1>The most thoroughly commented linker script (probably)</h1>
  <content>
    <p>While developing the firmware for Winterbloom's <a href="https://github.com/theacodes/Winterbloom_Castor_and_Pollux">Castor &amp; Pollux</a>, I got very curious as to just what the Microchip/Atmel-provided linker script was doing.</p>
<p>If you've never heard of or seen a linker script before you're not alone. Most of us never even have to think about them, however, on memory constained embedded devices it's not uncommon to need to modify the default linker script.</p>
<p>The linker script controls how <code>ld</code> combines all of your <code>.o</code> files into a single <code>.elf</code> and how that resulting <code>.elf</code> file gets loaded by the target processor.</p>
<p>So I was staring at this script that made absolutely no sense to me. It's filled with incantations and mysterious symbols and there's no indication of what they're for or where they come from.</p>
<p>So I did a <strong>lot</strong> of research and now I can present to you <strong>the most thoroughly commented linker script</strong><sup id="fnref:probably"><a class="footnote-ref" href="#fn:probably">1</a></sup>.</p>
<p>You can see this script in its entirety, comments and all, on <a href="https://github.com/theacodes/Winterbloom_Castor_and_Pollux/blob/master/firmware/scripts/samd21g18a.ld">GitHub</a>. But if you'd like to read it here instead it's transcribed below.</p>
<h2 id="output-format">Output format</h2>
<p>Output format sets the ELF output format to use a specific BFD backend.</p>
<p>The first is the default BFD. The second and third arguments are used
when big (-EB) or little (-EL) endian is requested.</p>
<p>Since the SAM D series are configured with only little endian support,
"elf32-littlearm" is used across the board. This option seems to be
included by Atmel/Microchip out of an abundance of caution, as
arm-none-eabi-ld will do the right thing and use "elf32-littlearm" by
default.</p>
<p>The list of acceptable values can be obtained using <code>objdump -i</code>.</p>
<p>References:</p>
<ul>
<li><a href="https://sourceware.org/binutils/docs/ld/Format-Commands.html#Format-Commands">https://sourceware.org/binutils/docs/ld/Format-Commands.html#Format-Commands</a></li>
<li><a href="https://sourceware.org/binutils/docs/ld/BFD.html">https://sourceware.org/binutils/docs/ld/BFD.html</a></li>
<li><a href="https://ww1.microchip.com/downloads/en/DeviceDoc/SAM_D21_DA1_Family_DataSheet_DS40001882F.pdf">https://ww1.microchip.com/downloads/en/DeviceDoc/SAM_D21_DA1_Family_DataSheet_DS40001882F.pdf</a>
    Section 11.1.11, Cortex M0+ Configuration</li>
</ul>
<pre class="lang-c"><span class="n">OUTPUT_FORMAT</span><span class="p">(</span><span class="s">&quot;elf32-littlearm&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;elf32-littlearm&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;elf32-littlearm&quot;</span><span class="p">)</span><span class="w"></span>
</pre>
<h2 id="cpu-memory-configuration-variables">CPU memory configuration variables</h2>
<p>These variables are used by the following "MEMORY" command to define
the various memory spaces.</p>
<p>For the SAMD21G18A used by this project, the available Flash is
262kB and the available SRAM is 32kB.</p>
<p>This project also reserves 8kB for the bootloader and 1kB for
"non-volatile memory" (NVM) - which is used by the application
to store calibration and user settings.</p>
<p>References:</p>
<ul>
<li><a href="https://ww1.microchip.com/downloads/en/DeviceDoc/SAM_D21_DA1_Family_DataSheet_DS40001882F.pdf">https://ww1.microchip.com/downloads/en/DeviceDoc/SAM_D21_DA1_Family_DataSheet_DS40001882F.pdf</a>
    Section 10.2, Physical Memory Map</li>
</ul>
<pre class="lang-c"><span class="n">FLASH_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x40000</span><span class="p">;</span><span class="w">      </span><span class="cm">/* 256kB */</span><span class="w"></span>
<span class="n">BOOTLOADER_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2000</span><span class="p">;</span><span class="w">  </span><span class="cm">/* 8kB */</span><span class="w"></span>
<span class="n">NVM_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x400</span><span class="p">;</span><span class="w">          </span><span class="cm">/* 1kbB */</span><span class="w"></span>
<span class="n">SRAM_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x8000</span><span class="p">;</span><span class="w">        </span><span class="cm">/* 32kB */</span><span class="w"></span>
</pre>
<p>ARM Cortex-M processors use a descending stack and generally
require stack space to be set aside in RAM.</p>
<p>The application's behavior determines just how much stack space
should be reserved. I generally start with 2kB (0x800) of
stack space for Cortex-M0+ projects programmed in C .</p>
<p>You can analyze stack usage in GCC using the <code>-fstack-usage</code>
flag and you can enable compiler warnings for stack usage
with <code>-Wstack-usage=STACK_SIZE</code>.</p>
<p>References:</p>
<ul>
<li><a href="https://embeddedartistry.com/blog/2020/08/17/three-gcc-flags-for-analyzing-memory-usage/">https://embeddedartistry.com/blog/2020/08/17/three-gcc-flags-for-analyzing-memory-usage/</a></li>
<li><a href="https://community.arm.com/developer/ip-products/processors/b/processors-ip-blog/posts/how-much-stack-memory-do-i-need-for-my-arm-cortex--m-applications">https://community.arm.com/developer/ip-products/processors/b/processors-ip-blog/posts/how-much-stack-memory-do-i-need-for-my-arm-cortex--m-applications</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gnat_ugn/Static-Stack-Usage-Analysis.html">https://gcc.gnu.org/onlinedocs/gnat_ugn/Static-Stack-Usage-Analysis.html</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html">https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html</a></li>
</ul>
<pre class="lang-c"><span class="n">STACK_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFINED</span><span class="p">(</span><span class="n">__stack_size__</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">__stack_size__</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0x800</span><span class="p">;</span><span class="w"></span>
</pre>
<h2 id="memory-space-definition">Memory space definition</h2>
<p>This section declare blocks of memories for specific purposes. Since an
ARM's address space is generally split between Flash, SRAM, peripherals,
and other regions, it's necessary to tell the linker where different
types of data can go in the address space.</p>
<p>These blocks will be used in the <code>SECTIONS</code> command below.</p>
<p>References:</p>
<ul>
<li><a href="https://sourceware.org/binutils/docs/ld/MEMORY.html#MEMORY">https://sourceware.org/binutils/docs/ld/MEMORY.html#MEMORY</a></li>
<li><a href="https://ww1.microchip.com/downloads/en/DeviceDoc/SAM_D21_DA1_Family_DataSheet_DS40001882F.pdf">https://ww1.microchip.com/downloads/en/DeviceDoc/SAM_D21_DA1_Family_DataSheet_DS40001882F.pdf</a>
    Section 10.2, Physical Memory Map</li>
</ul>
<pre class="lang-c"><span class="n">MEMORY</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
</pre>
<p>Start with the Flash memory region. On the SAMD21, Flash starts at
the beginning of the address space (<code>0x00000000</code>) and is contiguous
right up to the size of the Flash. Flash is marked a <code>rx</code> so
that the linker knows that this space is read-only (<code>r</code>) and
executable (<code>x</code>).</p>
<p>The "bootloader" section allows this firmware to work with the uf2
bootloader. The bootloader takes the first 0x2000 bytes of flash
memory.</p>
<p>References:</p>
<ul>
<li><a href="https://github.com/adafruit/uf2-samdx1#configuration">https://github.com/adafruit/uf2-samdx1#configuration</a></li>
</ul>
<pre class="lang-c"><span class="w">    </span><span class="n">bootloader</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ORIGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000000</span><span class="p">,</span><span class="w"> </span><span class="n">LENGTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BOOTLOADER_SIZE</span><span class="w"></span>
</pre>
<p>Following the bootloader is the flash memory used by the application,
called "rom" here - even though it's flash, the name is just a name
and doesn't carry special meaning.</p>
<p>The total length of the rom block is the MCU's flash size minus the
bootloader's size and any space reserved for "non-volatile memory"
by the application.</p>
<pre class="lang-c"><span class="w">   </span><span class="n">rom</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ORIGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00002000</span><span class="p">,</span><span class="w"> </span><span class="n">LENGTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLASH_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">BOOTLOADER_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">NVM_SIZE</span><span class="w"></span>
</pre>
<p>The "nvm" block is space set aside for the application to store
user settings and calibration data in the MCU's flash.</p>
<p>The block is located right at the end of the flash space. This
is useful because it means that it says in a fixed location
regardless of how much flash space the application takes up
in "rom". Explicitly defining this section also lets the
linker ensure that application code doesn't overwrite the
data in this region.</p>
<p>This block is marked as read-only (<code>r</code>) because flash can not
be written in the same way as normal memory, however, the
application can use the SAMD's NVM peripheral to write data in
this region.</p>
<pre class="lang-c"><span class="w">   </span><span class="n">nvm</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ORIGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FLASH_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">NVM_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">LENGTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NVM_SIZE</span><span class="w"></span>
</pre>
<p>The "ram" block is mapped to the CPU's SRAM and it's where
the stack, heap, and all variables will go.</p>
<p>For the SAMD21, SRAM starts at 0x20000000 and is contiguous
for the size of the SRAM.</p>
<pre class="lang-c"><span class="w">   </span><span class="n">ram</span><span class="w"> </span><span class="p">(</span><span class="n">rwx</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ORIGIN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x20000000</span><span class="p">,</span><span class="w"> </span><span class="n">LENGTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SRAM_SIZE</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>
<h2 id="sections">Sections</h2>
<p>The sections command tells the linker how to combine the
input files into an output ELF and where segments belong
in memory.</p>
<p>The linker takes a set of input files containing the "input
sections" and uses this to map them to "output sections"
which are placed in the output ELF file.</p>
<p>While the most important sections to think about here
are the ones that'll be placed into the memory (segments)
some sections are just placed in the output ELF for debugging.</p>
<p>References:</p>
<ul>
<li><a href="https://sourceware.org/binutils/docs/ld/SECTIONS.html#SECTIONS">https://sourceware.org/binutils/docs/ld/SECTIONS.html#SECTIONS</a></li>
</ul>
<pre class="lang-c"><span class="n">SECTIONS</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
</pre>
<p>The text segment contains program code and read-only data.</p>
<p>References:</p>
<ul>
<li><a href="https://developer.arm.com/documentation/dui0101/a/">https://developer.arm.com/documentation/dui0101/a/</a>
Page 5, Segments</li>
<li><a href="http://www.sco.com/developers/gabi/latest/ch4.sheader.html#special_sections">http://www.sco.com/developers/gabi/latest/ch4.sheader.html#special_sections</a></li>
</ul>
<pre class="lang-c"><span class="w">   </span><span class="p">.</span><span class="n">text</span><span class="w"> </span><span class="o">:</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
</pre>
<p>This segment must be 4-byte aligned as defined in ARM ELF
File Format specification.</p>
<pre class="lang-c"><span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
</pre>
<p>The vector table defines the initial stack pointer and
interrupt/exception routines for the ARM CPU and device
peripherals. Every Cortex-M project needs this.</p>
<p>For the SAM D series the vector table is expected
to be at address 0x00000000 after reset. Since
flash memory starts at 0x00000000, the first values
in flash should be the vector table.</p>
<p>When defining the vector table in code you must use
<code>__attribute__ ((section(".vectors")))</code> to tell
GCC to place the vector table into the section
named ".vectors" in the input object file so that
the linker can find it.</p>
<p>Note that since this project uses the UF2 bootloader,
this actually gets placed at the beginning of the
program's flash area (0x2000). The Cortex-M allows
changing the vector table after initialization,
so the startup script sets the Vector Table Offset
Register (<code>SCB-&gt;VTOR</code>) to <code>_sfixed</code> during its
intialization. The <code>_efixed</code> symbol is unused but
included for completeness.</p>
<p>References:</p>
<ul>
<li><a href="https://ww1.microchip.com/downloads/en/DeviceDoc/SAM_D21_DA1_Family_DataSheet_DS40001882F.pdf">https://ww1.microchip.com/downloads/en/DeviceDoc/SAM_D21_DA1_Family_DataSheet_DS40001882F.pdf</a>
Secion 8.3.3, Fetching of Initial Instructions</li>
<li><a href="https://static.docs.arm.com/ddi0403/eb/DDI0403E_B_armv7m_arm.pdf">https://static.docs.arm.com/ddi0403/eb/DDI0403E_B_armv7m_arm.pdf</a>
Section B1.5.3, The vector table
Section B3.2.5, Vector Table Offset Register, VTOR</li>
<li><a href="https://github.com/theacodes/Winterbloom_Castor_and_Pollux/tree/master/firmware/third_party/samd21/gcc/gcc/startup_samd21.c">startup_samd21.c</a></li>
</ul>
<pre class="lang-c"><span class="w">      </span><span class="n">_sfixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(.</span><span class="n">vectors</span><span class="w"> </span><span class="p">.</span><span class="n">vectors</span><span class="p">.</span><span class="o">*</span><span class="p">))</span><span class="w"></span>
</pre>
<p>Include code and read-only data sections from all
input files.</p>
<p>By default, GCC places all program code into a section named
".text" and read-only data (such as const static variables) into
a section named ".rodata" in the input object files. This naming
convention is from the ELF ABI specification.</p>
<p>GCC generates three "flavors" of sections in object files:</p>
<ul>
<li><code>.{section}</code>: the basic section.</li>
<li><code>.{section}.*</code>: sections generated by <code>-ffunction-sections</code> and
<code>-fdata-sections</code> so that each function/data has a unique
section.</li>
<li><code>.gnu.linkonce.{type}.*</code>: sections generated by GCC so the
linker can remove duplicates. Seems to be related to
Vague Linking.</li>
</ul>
<p>References:</p>
<ul>
<li><a href="http://www.sco.com/developers/gabi/latest/ch4.sheader.html#special_sections">http://www.sco.com/developers/gabi/latest/ch4.sheader.html#special_sections</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Vague-Linkage.html">https://gcc.gnu.org/onlinedocs/gcc/Vague-Linkage.html</a></li>
<li><a href="https://stackoverflow.com/questions/5518083/what-is-a-linkonce-section">https://stackoverflow.com/questions/5518083/what-is-a-linkonce-section</a></li>
</ul>
<pre class="lang-c"><span class="w">      </span><span class="o">*</span><span class="p">(.</span><span class="n">text</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">linkonce</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="p">(.</span><span class="n">rodata</span><span class="w"> </span><span class="p">.</span><span class="n">rodata</span><span class="o">*</span><span class="w"> </span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">linkonce</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
</pre>
<h2 id="c-c-runtime-support">C &amp; C++ runtime support</h2>
<p>The following sections are for the C/C++ runtime. These are generally used by crt0.</p>
<p>References:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Crt0">https://en.wikipedia.org/wiki/Crt0</a></li>
</ul>
<h3 id="initializers">Initializers</h3>
<ul>
<li>C++ Runtime: initializers for static variables.</li>
<li>C Runtime: designated constructors</li>
</ul>
<p>For C++, handles variables at file scope like this:</p>
<pre class="lang-c++"><span class="kt">int</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">some_func</span><span class="p">()</span><span class="w"></span>
</pre>
<p>For C, handles functions designated as constructors:</p>
<pre><code>void intialize_thing(void) __attribute__((constructor));
</code></pre>
<p>Executed by the C runtime at startup via <code>__libc_init_array</code>.</p>
<p>References:</p>
<ul>
<li><a href="https://github.com/gcc-mirror/gcc/blob/master/libgcc/crtstuff.c">https://github.com/gcc-mirror/gcc/blob/master/libgcc/crtstuff.c</a></li>
<li><a href="https://sourceware.org/git/?p=newlib-cygwin.git;a=blob;f=newlib/libc/misc/init.c">https://sourceware.org/git/?p=newlib-cygwin.git;a=blob;f=newlib/libc/misc/init.c</a>;</li>
<li><a href="https://gcc.gnu.org/onlinedocs/gccint/Initialization.html">https://gcc.gnu.org/onlinedocs/gccint/Initialization.html</a></li>
<li><a href="https://developer.arm.com/documentation/dui0475/h/the-arm-c-and-c---libraries/c---initialization--construction-and-destruction">https://developer.arm.com/documentation/dui0475/h/the-arm-c-and-c---libraries/c---initialization--construction-and-destruction</a></li>
<li><a href="https://stackoverflow.com/questions/15265295/understanding-the-libc-init-array">https://stackoverflow.com/questions/15265295/understanding-the-libc-init-array</a></li>
</ul>
<pre class="lang-c"><span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(.</span><span class="n">init</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">__preinit_array_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(.</span><span class="n">preinit_array</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">__preinit_array_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>

<span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">__init_array_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(.</span><span class="n">init_array</span><span class="p">.</span><span class="o">*</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(.</span><span class="n">init_array</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">__init_array_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
</pre>
<h3 id="finalizers">Finalizers</h3>
<ul>
<li>C++ runtime: destructors for static variables.</li>
<li>C runtime: designated finializers</li>
</ul>
<p>For C, handles functions designated as destructors:</p>
<pre class="lang-c"><span class="kt">void</span><span class="w"> </span><span class="nf">destroy_thing</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">__attribute__</span><span class="p">((</span><span class="n">destructor</span><span class="p">));</span><span class="w"></span>
</pre>
<p>References:</p>
<ul>
<li><a href="https://sourceware.org/git/?p=newlib-cygwin.git;a=blob;f=newlib/libc/misc/fini.c">https://sourceware.org/git/?p=newlib-cygwin.git;a=blob;f=newlib/libc/misc/fini.c</a></li>
</ul>
<pre class="lang-c"><span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(.</span><span class="n">fini</span><span class="p">))</span><span class="w"></span>

<span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">__fini_array_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(.</span><span class="n">fini_array</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(.</span><span class="n">fini_array</span><span class="p">.</span><span class="o">*</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="n">__fini_array_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
</pre>
<h3 id="c-runtime-static-constructors">C++ runtime: static constructors</h3>
<p>References:</p>
<ul>
<li><a href="https://gcc.gnu.org/onlinedocs/gccint/Initialization.html">https://gcc.gnu.org/onlinedocs/gccint/Initialization.html</a></li>
<li><a href="https://github.com/gcc-mirror/gcc/blob/master/libgcc/crtstuff.c">https://github.com/gcc-mirror/gcc/blob/master/libgcc/crtstuff.c</a></li>
</ul>
<pre class="lang-c"><span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">crtbegin</span><span class="p">.</span><span class="n">o</span><span class="p">(.</span><span class="n">ctors</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">EXCLUDE_FILE</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">crtend</span><span class="p">.</span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="n">ctors</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(.</span><span class="n">ctors</span><span class="p">.</span><span class="o">*</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">crtend</span><span class="p">.</span><span class="n">o</span><span class="p">(.</span><span class="n">ctors</span><span class="p">))</span><span class="w"></span>
</pre>
<h3 id="c-runtime-static-destructors-and-atexit">C++ runtime: static destructors and atexit()</h3>
<p>Note that in usual practice these aren't ever called because the program
doesn't exit - except when powered off or reset.</p>
<p>References:</p>
<ul>
<li><a href="https://gcc.gnu.org/onlinedocs/gccint/Initialization.html">https://gcc.gnu.org/onlinedocs/gccint/Initialization.html</a></li>
</ul>
<pre class="lang-c"><span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">crtbegin</span><span class="p">.</span><span class="n">o</span><span class="p">(.</span><span class="n">dtors</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">EXCLUDE_FILE</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">crtend</span><span class="p">.</span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="n">dtors</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(.</span><span class="n">dtors</span><span class="p">.</span><span class="o">*</span><span class="p">)))</span><span class="w"></span>
<span class="w">      </span><span class="n">KEEP</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">crtend</span><span class="p">.</span><span class="n">o</span><span class="p">(.</span><span class="n">dtors</span><span class="p">))</span><span class="w"></span>

<span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">_efixed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rom</span><span class="w"></span>
</pre>
<h2 id="arm-exception-handling">ARM exception handling</h2>
<p>ARM defines several special sections for exception handling.</p>
<p>These are require for C++ and for C programs that try to
examine backtraces.</p>
<ul>
<li><code>exidx</code> is used to contain index entries for stack unwinding.</li>
<li><code>extab</code> names sections containing exception unwinding information.</li>
</ul>
<p>Essentially, each function that can throw an exception will
have entries in the exidx and extab sections.</p>
<p>References:</p>
<ul>
<li><a href="https://developer.arm.com/documentation/ihi0038/b/">https://developer.arm.com/documentation/ihi0038/b/</a></li>
<li><a href="https://stackoverflow.com/a/57463515">https://stackoverflow.com/a/57463515</a></li>
</ul>
<pre class="lang-c"><span class="w">   </span><span class="p">.</span><span class="n">ARM</span><span class="p">.</span><span class="n">extab</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="p">(.</span><span class="n">ARM</span><span class="p">.</span><span class="n">extab</span><span class="o">*</span><span class="w"> </span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">linkonce</span><span class="p">.</span><span class="n">armextab</span><span class="p">.</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rom</span><span class="w"></span>

<span class="w">   </span><span class="p">.</span><span class="n">ARM</span><span class="p">.</span><span class="n">exidx</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">PROVIDE</span><span class="w"> </span><span class="p">(</span><span class="n">__exidx_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="p">(.</span><span class="n">ARM</span><span class="p">.</span><span class="n">exidx</span><span class="o">*</span><span class="w"> </span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">linkonce</span><span class="p">.</span><span class="n">armexidx</span><span class="p">.</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">PROVIDE</span><span class="w"> </span><span class="p">(</span><span class="n">__exidx_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.);</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rom</span><span class="w"></span>
</pre>
<h2 id="relocate">Relocate</h2>
<p>The <code>.relocate</code> section includes mutable variables that have a
default value and specially marked functions that should execute
from RAM.</p>
<p>This data is stored in ROM but is referenced from RAM. The
program/runtime must copy the data from ROM to RAM on reset,
hence, "relocate".</p>
<p>Performance sensitive/critical functions can also be placed in
RAM using this section:</p>
<pre class="lang-c"><span class="cp">#define RAMFUNC __attribute__((section(&quot;.ramfunc&quot;)))</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">fast_function</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">RAMFUNC</span><span class="p">;</span><span class="w"></span>
</pre>
<p>In other linker scripts you might see this named as the <code>.data</code>
section. That's what the ELF specification calls for, but the
Microchip-provided SAM D startup scripts expect <code>.relocate</code>.</p>
<p>This also sets the symbol <code>_etext</code> to the start of the relocation
segment in flash. The startup script copies the data starting at
<code>_etext</code> to <code>_srelocate</code> and ends when it reaches <code>_erelocate</code>.
The <code>_etext</code> name is a bit unfortunate since it's not the end of
the text segment, but rather the start of the read-only copy of the
relocate section in flash. If I wrote the startup script I would have
named these symbols differently.</p>
<p>References:</p>
<ul>
<li><a href="http://www.sco.com/developers/gabi/latest/ch4.sheader.html#special_sections">http://www.sco.com/developers/gabi/latest/ch4.sheader.html#special_sections</a></li>
<li><a href="https://www.sourceware.org/binutils/docs/ld/Output-Section-LMA.html#Output-Section-LMA">https://www.sourceware.org/binutils/docs/ld/Output-Section-LMA.html#Output-Section-LMA</a></li>
<li><a href="https://github.com/theacodes/Winterbloom_Castor_and_Pollux/tree/master/firmware/third_party/samd21/gcc/gcc/startup_samd21.c">startup_samd21.c</a></li>
</ul>
<pre class="lang-c"><span class="w">   </span><span class="p">.</span><span class="n">relocate</span><span class="w"> </span><span class="o">:</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">_srelocate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="p">(.</span><span class="n">ramfunc</span><span class="w"> </span><span class="p">.</span><span class="n">ramfunc</span><span class="p">.</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="p">(.</span><span class="n">data</span><span class="w"> </span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">_erelocate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ram</span><span class="w"> </span><span class="n">AT</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rom</span><span class="w"></span>

<span class="w">   </span><span class="n">_etext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LOADADDR</span><span class="p">(.</span><span class="n">relocate</span><span class="p">);</span><span class="w"></span>
</pre>
<h2 id="bss">BSS</h2>
<p>The BSS section reserves RAM space for declared but uninitialized
variables.</p>
<p>This is zeroed out by the startup script. The start-up script
zeros out the area of RAM starting at <code>_szero</code> and ending at
<code>_ezero</code>.</p>
<p>This includes <code>COMMON</code> which is a bit of a legacy section. GCC
defaults to <code>-fno-common</code> these days so there shouldn't be
anything in there, but it's included for completeness.</p>
<p>References:</p>
<ul>
<li><a href="http://www.sco.com/developers/gabi/latest/ch4.sheader.html#special_sections">http://www.sco.com/developers/gabi/latest/ch4.sheader.html#special_sections</a></li>
<li><a href="https://en.wikipedia.org/wiki/.bss">https://en.wikipedia.org/wiki/.bss</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Code-Gen-Options.html">https://gcc.gnu.org/onlinedocs/gcc/Code-Gen-Options.html</a>
Section -fcommon</li>
<li><a href="https://github.com/theacodes/Winterbloom_Castor_and_Pollux/tree/master/firmware/third_party/samd21/gcc/gcc/startup_samd21.c">startup_samd21.c</a></li>
</ul>
<pre class="lang-c"><span class="w">   </span><span class="p">.</span><span class="n">bss</span><span class="w"> </span><span class="p">(</span><span class="n">NOLOAD</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">_szero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="p">(.</span><span class="n">bss</span><span class="w"> </span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="o">*</span><span class="p">(</span><span class="n">COMMON</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">_ezero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ram</span><span class="w"></span>
</pre>
<h2 id="stack-space">Stack space</h2>
<p>Cortex-M stacks grow down, so the stack starts at <code>_estack</code> and
grows towards <code>_sstack</code>. The startup script sets the vector
table's stack pointer to <code>_estack</code> on startup. <code>_sstack</code> is
usused but included for completeness.</p>
<p>The ARM procedure call standard (AAPCS) requires the stack to be
aligned on an eight byte boundary.</p>
<p>References:</p>
<ul>
<li><a href="https://github.com/theacodes/Winterbloom_Castor_and_Pollux/tree/master/firmware/third_party/samd21/gcc/gcc/startup_samd21.c">startup_samd21.c</a></li>
<li><a href="https://developer.arm.com/documentation/ihi0042/e/">https://developer.arm.com/documentation/ihi0042/e/</a>
Section 5.2.1.2, Stack constraints at a public interface</li>
</ul>
<pre class="lang-c"><span class="w">   </span><span class="p">.</span><span class="n">stack</span><span class="w"> </span><span class="p">(</span><span class="n">NOLOAD</span><span class="p">)</span><span class="o">:</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">_sstack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">STACK_SIZE</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">_estack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ram</span><span class="w"></span>
</pre>
<h2 id="heap-space">Heap space</h2>
<p>If the program uses the malloc and the heap, then <code>_heap_start</code>
can be used as the start of the heap. If the program doesn't
use the heap then the <code>_heap_start</code> symbol is unused and could
be removed. With <code>-specs=nano.specs</code>, the <code>_sbrk</code> syscall has
to be implemented for malloc to work:</p>
<pre class="lang-c"><span class="k">extern</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_heap_start</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">_sbrk</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">incr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">heap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">prev_heap</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">heap</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">heap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">_heap_start</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">prev_heap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">heap</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">incr</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">prev_heap</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>
<p>Another memory layout strategy is to place the stack at the end
of RAM and the heap after bss. That way the heap can grow upwards
towards the stack and the stack can grow downwards to the heap.
However, I'm not a big fan of that approach- it's possible for the
heap to overwrite the stack. Leaving the entire end of RAM available
as the heap works well for my purposes.</p>
<p>References:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Sbrk">https://en.wikipedia.org/wiki/Sbrk</a></li>
<li><a href="https://interrupt.memfault.com/blog/boostrapping-libc-with-newlib">https://interrupt.memfault.com/blog/boostrapping-libc-with-newlib</a></li>
<li><a href="https://embeddedartistry.com/blog/2017/02/15/implementing-malloc-first-fit-free-list/">https://embeddedartistry.com/blog/2017/02/15/implementing-malloc-first-fit-free-list/</a></li>
</ul>
<pre class="lang-c"><span class="w">   </span><span class="p">.</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="n">PROVIDE</span><span class="w"> </span><span class="p">(</span><span class="n">_heap_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.);</span><span class="w"></span>
<span class="w">   </span><span class="n">_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="w"> </span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre>
<h2 id="absolute-symbol-definitions">Absolute symbol definitions</h2>
<p>This section defines some useful absolute symbols for the application
to use.</p>
<p>Symbols for the settings section in the NVM memory block.</p>
<p>Gemini uses the first half of the NVM block for user settings.
This symbol is used by the settings module to know where to
load and save settings.</p>
<p>References:</p>
<ul>
<li><a href="https://github.com/theacodes/Winterbloom_Castor_and_Pollux/tree/master/firmware/src/gem_settings_load_save.c">gem_settings_load_save.c</a></li>
</ul>
<pre class="lang-c"><span class="n">_nvm_settings_base_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ORIGIN</span><span class="p">(</span><span class="n">nvm</span><span class="p">);</span><span class="w"></span>
<span class="n">_nvm_settings_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LENGTH</span><span class="p">(</span><span class="n">nvm</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</pre>
<p>Symbols for the calibration/look-up table in the NVM memory block.</p>
<p>Gemini uses the other half of the NVM block to store the factory-
calibrated look-up table for translating ADC -&gt; frequency/DAC codes.</p>
<p>References:</p>
<ul>
<li><a href="https://github.com/theacodes/Winterbloom_Castor_and_Pollux/tree/master/firmware/src/gem_voice_param_table_load_save.c">gem_voice_param_table_load_save.c</a></li>
</ul>
<pre class="lang-c"><span class="n">_nvm_lut_base_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ORIGIN</span><span class="p">(</span><span class="n">nvm</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LENGTH</span><span class="p">(</span><span class="n">nvm</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="n">_nvm_lut_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LENGTH</span><span class="p">(</span><span class="n">nvm</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</pre>
<div class="footnote">
<hr />
<ol>
<li id="fn:probably">
<p>Probably.&#160;<a class="footnote-backref" href="#fnref:probably" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </content>
 
  <aside class="support-me">
    ð Hey, if you found this post useful I would love to <a href="mailto:me@thea.codes">hear from you</a>.
    If you loved it you can consider <a href="https://ko-fi.com/theacodes" target="_blank" rel="noopener">tipping me on Ko-fi</a> or <a href="https://github.com/sponsors/theacodes" target="_blank" rel="noopener">sponsoring me</a> on GitHub.
    I don't get paid for this content, so kind words and support encourage me to create more!
  </aside>
</article>


    <footer>
      <div class="row">
        <div class="col-md-1 d-none d-md-block img-me-container">
          <img class="img-me img-fluid" src="/static/me.png">
        </div>
        <div class="col-md info">
          <span class="name">Stargirl Flowers</span><br>
          <a href="https://thea.codes"><i class="fa fa-link" aria-hidden="true"></i> thea.codes</a>
          Â· <a href="https://github.com/theacodes" rel="noopener"><i class="fab fa-github" aria-hidden="true"></i> theacodes</a>
          Â· <a href="https://twitter.com/theavalkyrie" rel="noopener"><i class="fab fa-twitter" aria-hidden="true"></i> theavalkyrie</a>
          <br>
          <span class="location"><i class="fas fa-map-marker"></i> Atlanta, Georgia</span>
        </div>
        <div class="col-md">
          <p class="disclaimer">
            &copy; 2018 &mdash; 2020<br>
            All text is available under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC-BY-SA 4.0</a> license<br>
            All code is available under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0</a> license
          </p>
      </div>

    </footer>
  </div>

  <!-- webfonts & icons-->
  <link href="/static/fontawesome/css/fontawesome-all.min.css" rel="stylesheet">

  <!-- Google Analytics (that's right, I'm tracking you) -->
  <script async="" src="https://www.google-analytics.com/analytics.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47725506-1', 'blog.thea.codes');
    ga('send', 'pageview');

  </script>

</body>
</html>